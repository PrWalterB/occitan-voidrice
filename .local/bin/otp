#!/bin/sh

# Get a one-time password, or add a OTP secret to your pass-otp store.

# The assumption of this script is that all otp passwords are stored with the
# suffix `-otp`. This script automatically appends newly added otps as such.

# For OTP passwords to be generated properly, it is important for the local
# computer to have its time properly synced. This can be done with the command
# below which requires the package `ntp`.

ifinstalled pass pass-otp || exit 1

dir="${PASSWORD_STORE_DIR}"

choice="$({ echo "ðŸ†•botar" ; echo "ðŸ•™sinc-temps" ; ls "$dir"/*-otp.gpg ;} | sed "s/.*\///;s/-otp.gpg//" | dmenu -p "Chausissetz un 2FA:")"

case $choice in
	ðŸ†•botar )
		ifinstalled maim zbar || exit 1

		temp=$(mktemp -p "$XDG_RUNTIME_DIR" --suffix=.png)
		otp="otp-test-script"
		trap 'rm -f $temp; pass rm -f $otp' HUP INT QUIT TERM PWR EXIT

		notify-send "Scan the image." "Scannatz le QR cÃ²de OTP."

		maim -s "$temp" || exit 1
		info="$(zbarimg -q "$temp")"
		info="${info#QR-Code:}"

		if echo "$info" | pass otp insert "$otp"; then
			while true ; do
				export name="$(echo | dmenu -p "Balhatz per aqueste i-Un Temps senhau un nom i-un-mot:")"
				echo "$name" | grep -q -- "^[A-z0-9-]\+$" && break
			done
			pass mv "$otp" "$name-otp"
			notify-send "Ben botar." "$name-otp fuguÃ¨t creat."
		else
			notify-send "Pas de donadas OTP trobada." "Essatjatz de scannar l'imatge enquÃ¨ra d'un biais mai precis."
		fi
		;;
	ðŸ•™sync-time )
		ifinstalled ntp || exit 1
		notify-send -u low "ðŸ•™ Sincronizacion dau Temps..." "Sincronizacion dau temps embei daus servidors NTP..."
		updatedata="$(sudo ntpdate pool.ntp.org)" &&
		notify-send -u low "ðŸ•™ Sincronizacion dau Temps..." "Achabat. Temps chanjat per ${updatedata#*offset }"
		;;
	*) pass otp -c ${choice}-otp ;;
esac
